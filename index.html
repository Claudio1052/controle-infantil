<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Ministerial | Verbo da Vida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
    <style>
        /* [MANTENHA TODO O SEU CSS ORIGINAL AQUI] */
        /* ... seu CSS completo permanece igual ... */
    </style>
</head>
<body data-theme="light">
  
    <div class="connection-status status-error" id="connection-status">
        <i class="fas fa-sync fa-spin"></i> Testando Conex√£o...
    </div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">Carregando dados...</p>
    </div>
    <div class="wrapper">
        <!-- [MANTENHA TODO O SEU HTML ORIGINAL AQUI] -->
        <!-- ... seu HTML completo permanece igual ... -->
    </div>
    <div id="toast-container"></div>
    <script>
        // ==============================================
        // CONFIGURA√á√ÉO SUPABASE (CORRIGIDA E SEGURA)
        // ==============================================
        const SUPABASE_URL = 'https://wzzyxbkhmlfilvlihvvl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6enl4YmtobWxmaWx2bGlodnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTAzNzcsImV4cCI6MjA3ODYyNjM3N30.K_QwwVD20xnlhNvTxb0jdTeH_3LU30W_aDeHquraQg8';

        // Criar cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            },
            db: {
                schema: 'public'
            },
            realtime: {
                params: {
                    eventsPerSecond: 10
                }
            }
        });

        // ==============================================
        // ESTADO GLOBAL MELHORADO
        // ==============================================
        let estado = {
            cultos: [],
            escalas: [],
            membros: [],
            charts: {},
            theme: localStorage.getItem('app-theme') || 'light',
            lastUpdate: null,
            connectionStatus: 'disconnected'
        };

        // ==============================================
        // INICIALIZA√á√ÉO MELHORADA
        // ==============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando aplica√ß√£o...');
            
            // Aplica tema salvo
            applyTheme(estado.theme);
            
            // Configura listeners
            setupEventListeners();
            
            // Inicia monitoramento de conex√£o
            startConnectionMonitoring();
            
            // Tenta conectar e carregar dados
            await initializeApp();
            
            // Esconde loading
            document.getElementById('loading-overlay').style.display = 'none';
            
            console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');
        });

        // ==============================================
        // FUN√á√ïES DE CONEX√ÉO MELHORADAS
        // ==============================================
        async function startConnectionMonitoring() {
            // Monitora conex√£o a cada 30 segundos
            setInterval(async () => {
                await checkConnection();
            }, 30000);
            
            // Monitora online/offline do navegador
            window.addEventListener('online', () => {
                showToast('Conex√£o com internet restabelecida!', 'success');
                checkConnection();
            });
            
            window.addEventListener('offline', () => {
                showToast('Sem conex√£o com internet', 'error');
                updateConnectionStatus('offline');
            });
        }

        async function checkConnection() {
            const statusEl = document.getElementById('connection-status');
            
            try {
                // Teste mais robusto de conex√£o
                const startTime = Date.now();
                const { data, error, count } = await supabase
                    .from('cultos')
                    .select('id', { count: 'exact', head: true })
                    .limit(1);
                
                const responseTime = Date.now() - startTime;
                
                if (error) throw error;
                
                estado.connectionStatus = 'connected';
                statusEl.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <span>Conectado (${responseTime}ms)</span>
                `;
                statusEl.className = 'connection-status status-ok';
                
                // Atualiza timestamp
                estado.lastUpdate = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                estado.connectionStatus = 'error';
                statusEl.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Erro: ${error.message || 'Falha na conex√£o'}</span>
                `;
                statusEl.className = 'connection-status status-error';
                
                // Tenta reconex√£o autom√°tica
                setTimeout(checkConnection, 5000);
            }
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            if (status === 'offline') {
                estado.connectionStatus = 'offline';
                statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                statusEl.className = 'connection-status status-error';
            }
        }

        // ==============================================
        // INICIALIZA√á√ÉO DO APP
        // ==============================================
        async function initializeApp() {
            try {
                // 1. Verifica conex√£o primeiro
                await checkConnection();
                
                if (estado.connectionStatus !== 'connected') {
                    showToast('Aguardando conex√£o com o servidor...', 'warning');
                    return;
                }
                
                // 2. Carrega dados em paralelo com feedback
                await loadAllData();
                
                // 3. Atualiza UI
                updateUI();
                
                // 4. Inicia atualiza√ß√µes em tempo real (opcional)
                // setupRealtimeSubscriptions();
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showToast('Falha ao inicializar aplica√ß√£o', 'error');
            }
        }

        // ==============================================
        // CARREGAMENTO DE DADOS OTIMIZADO
        // ==============================================
        async function loadAllData() {
            document.getElementById('loading-text').innerText = "Carregando dados...";
            
            try {
                // Carrega dados em paralelo
                const [cultosData, escalasData, membrosData] = await Promise.allSettled([
                    supabase.from('cultos').select('*').order('data_culto', { ascending: false }),
                    supabase.from('escalas').select('*'),
                    supabase.from('membros').select('*').order('nome')
                ]);
                
                // Processa resultados
                estado.cultos = cultosData.status === 'fulfilled' ? (cultosData.value.data || []) : [];
                estado.escalas = escalasData.status === 'fulfilled' ? (escalasData.value.data || []) : [];
                estado.membros = membrosData.status === 'fulfilled' ? (membrosData.value.data || []) : [];
                
                // Log de estat√≠sticas
                console.log(`üìä Dados carregados: ${estado.cultos.length} cultos, ${estado.membros.length} membros`);
                
                if (cultosData.status === 'rejected') {
                    console.error('Erro ao carregar cultos:', cultosData.reason);
                    showToast('Aviso: Alguns dados podem estar incompletos', 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                throw error;
            }
        }

        // ==============================================
        // FUN√á√ïES CRUD MELHORADAS
        // ==============================================
        async function salvarCulto(e) {
            e.preventDefault();
            
            // Valida√ß√£o b√°sica
            const dataCulto = document.getElementById('data-culto').value;
            if (!dataCulto) {
                showToast('Por favor, informe a data do culto', 'error');
                return;
            }
            
            showLoading('Salvando culto...');
            
            try {
                const novoCulto = {
                    data_culto: dataCulto,
                    dia_semana: document.getElementById('dia-semana').value,
                    tipo_culto: document.getElementById('tipo-culto').value,
                    hora_inicio: document.getElementById('hora-inicio').value,
                    hora_termino: document.getElementById('hora-termino').value,
                    tempo_ministerio: parseInt(document.getElementById('tempo-ministerio').value) || 0,
                    homens: parseInt(document.getElementById('homens').value) || 0,
                    mulheres: parseInt(document.getElementById('mulheres').value) || 0,
                    criancas: parseInt(document.getElementById('criancas').value) || 0,
                    ministro: document.getElementById('ministro').value.trim(),
                    dirigente: document.getElementById('dirigente').value.trim(),
                    observacoes: document.getElementById('observacoes').value.trim(),
                    criado_em: new Date().toISOString()
                };
                
                // Valida total presente
                const totalPresentes = novoCulto.homens + novoCulto.mulheres + novoCulto.criancas;
                if (totalPresentes === 0) {
                    if (!confirm('Total de presentes √© zero. Deseja continuar?')) {
                        hideLoading();
                        return;
                    }
                }
                
                // 1. Salva o culto
                const { data: culto, error: cultoError } = await supabase
                    .from('cultos')
                    .insert([novoCulto])
                    .select()
                    .single();
                    
                if (cultoError) throw cultoError;
                
                // 2. Salva escalas (se houver)
                const escalasParaSalvar = [];
                const departamentos = ['diaconato', 'infantil', 'musica', 'midia'];
                
                departamentos.forEach(dept => {
                    const nomes = document.getElementById(dept).value.trim();
                    if (nomes) {
                        escalasParaSalvar.push({
                            culto_id: culto.id,
                            departamento: dept.charAt(0).toUpperCase() + dept.slice(1),
                            nomes: nomes,
                            criado_em: new Date().toISOString()
                        });
                    }
                });
                
                if (escalasParaSalvar.length > 0) {
                    const { error: escalasError } = await supabase
                        .from('escalas')
                        .insert(escalasParaSalvar);
                        
                    if (escalasError) throw escalasError;
                }
                
                // Sucesso
                showToast('Culto registrado com sucesso!', 'success');
                document.getElementById('culto-form').reset();
                document.getElementById('data-culto').valueAsDate = new Date();
                
                // Recarrega dados e atualiza UI
                await loadAllData();
                updateUI();
                
                // Navega para dashboard
                document.getElementById('dashboard-tab').click();
                
            } catch (error) {
                console.error('Erro ao salvar culto:', error);
                showToast(`Erro: ${error.message || 'Falha ao salvar'}`, 'error');
                
                // Tenta mostrar detalhes do erro
                if (error.code === '23505') {
                    showToast('Erro: Registro duplicado', 'error');
                } else if (error.code === '42501') {
                    showToast('Erro de permiss√£o. Verifique pol√≠ticas RLS.', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function salvarMembro(e) {
            e.preventDefault();
            
            showLoading('Salvando membro...');
            
            try {
                const membroId = document.getElementById('membro-id').value;
                const membroData = {
                    nome: document.getElementById('membro-nome').value.trim(),
                    telefone: document.getElementById('membro-telefone').value.trim() || null,
                    nascimento: document.getElementById('membro-nascimento').value || null,
                    email: document.getElementById('membro-email').value.trim() || null,
                    fez_rhema: document.getElementById('membro-rhema').value === 'true',
                    escola_ministros: document.getElementById('membro-escola').value === 'true',
                    departamentos: Array.from(document.getElementById('membro-departamentos').selectedOptions)
                        .map(opt => opt.value),
                    atualizado_em: new Date().toISOString()
                };
                
                // Valida√ß√£o
                if (!membroData.nome) {
                    throw new Error('Nome √© obrigat√≥rio');
                }
                
                let result;
                if (membroId) {
                    // Atualiza√ß√£o
                    result = await supabase
                        .from('membros')
                        .update(membroData)
                        .eq('id', membroId)
                        .select()
                        .single();
                } else {
                    // Inser√ß√£o
                    membroData.criado_em = new Date().toISOString();
                    membroData.ativo = true;
                    result = await supabase
                        .from('membros')
                        .insert([membroData])
                        .select()
                        .single();
                }
                
                const { error } = result;
                if (error) throw error;
                
                showToast(membroId ? 'Membro atualizado!' : 'Membro cadastrado!', 'success');
                fecharModalMembro();
                await loadAllData();
                updateUI();
                
            } catch (error) {
                console.error('Erro ao salvar membro:', error);
                showToast(`Erro: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ==============================================
        // FUN√á√ïES DE UI MELHORADAS
        // ==============================================
        function updateUI() {
            renderDashboard();
            renderHistorico();
            renderEscalas();
            renderMembros();
            updateBadges();
            updateLastUpdateTime();
        }

        function renderDashboard() {
            // C√°lculos estat√≠sticos
            const totalCultos = estado.cultos.length;
            const totalPublico = estado.cultos.reduce((acc, c) => acc + (c.homens + c.mulheres + c.criancas), 0);
            const mediaPublico = totalCultos > 0 ? Math.round(totalPublico / totalCultos) : 0;
            const totalMembros = estado.membros.length;
            const membrosAtivos = estado.membros.filter(m => m.ativo !== false).length;
            
            // √öltimos 30 dias
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
            const cultosRecentes = estado.cultos.filter(c => new Date(c.data_culto) >= trintaDiasAtras);
            const publicoRecente = cultosRecentes.reduce((acc, c) => acc + (c.homens + c.mulheres + c.criancas), 0);
            
            // Cards dashboard
            document.getElementById('dashboard-cards').innerHTML = `
                <div class="card card-info">
                    <div class="card-header">
                        <div class="card-title">M√©dia de P√∫blico</div>
                        <div class="card-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="card-value">${mediaPublico}</div>
                    <div class="card-subvalue">Total: ${totalPublico} pessoas</div>
                </div>
                <div class="card card-success">
                    <div class="card-header">
                        <div class="card-title">Cultos Registrados</div>
                        <div class="card-icon"><i class="fas fa-church"></i></div>
                    </div>
                    <div class="card-value">${totalCultos}</div>
                    <div class="card-subvalue">${cultosRecentes.length} √∫ltimos 30 dias</div>
                </div>
                <div class="card card-warning">
                    <div class="card-header">
                        <div class="card-title">Base de Membros</div>
                        <div class="card-icon"><i class="fas fa-user-check"></i></div>
                    </div>
                    <div class="card-value">${membrosAtivos}</div>
                    <div class="card-subvalue">De ${totalMembros} cadastrados</div>
                </div>
                <div class="card card-secondary">
                    <div class="card-header">
                        <div class="card-title">P√∫blico Recente</div>
                        <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                    </div>
                    <div class="card-value">${publicoRecente}</div>
                    <div class="card-subvalue">√öltimos 30 dias</div>
                </div>
            `;
            
            // Atualiza gr√°ficos
            renderCharts();
            renderTimeline();
        }

        function renderCharts() {
            // Gr√°fico de tend√™ncia (√∫ltimos 10 cultos)
            const ultimosCultos = [...estado.cultos].slice(0, 10).reverse();
            if (ultimosCultos.length === 0) return;
            
            const labels = ultimosCultos.map(c => 
                new Date(c.data_culto).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})
            );
            const dataTotal = ultimosCultos.map(c => c.homens + c.mulheres + c.criancas);
            
            // Gr√°fico de linha
            const ctxGrowth = document.getElementById('growthChart')?.getContext('2d');
            if (ctxGrowth) {
                if (estado.charts.growth) estado.charts.growth.destroy();
                
                estado.charts.growth = new Chart(ctxGrowth, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P√∫blico Total',
                            data: dataTotal,
                            borderColor: getComputedStyle(document.body).getPropertyValue('--primary'),
                            backgroundColor: 'rgba(26, 95, 180, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.parsed.y} pessoas`
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico demogr√°fico
            const totalH = estado.cultos.reduce((a,c) => a + (c.homens || 0), 0);
            const totalM = estado.cultos.reduce((a,c) => a + (c.mulheres || 0), 0);
            const totalC = estado.cultos.reduce((a,c) => a + (c.criancas || 0), 0);
            
            const ctxDemo = document.getElementById('demographicsChart')?.getContext('2d');
            if (ctxDemo) {
                if (estado.charts.demo) estado.charts.demo.destroy();
                
                estado.charts.demo = new Chart(ctxDemo, {
                    type: 'doughnut',
                    data: {
                        labels: ['Homens', 'Mulheres', 'Crian√ßas'],
                        datasets: [{
                            data: [totalH, totalM, totalC],
                            backgroundColor: [
                                '#3498db',
                                '#e91e63',
                                '#27ae60'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // ==============================================
        // FUN√á√ïES AUXILIARES MELHORADAS
        // ==============================================
        function setupEventListeners() {
            // Formul√°rio de culto
            const formCulto = document.getElementById('culto-form');
            if (formCulto) {
                formCulto.addEventListener('submit', salvarCulto);
            }
            
            // Formul√°rio de membro
            const formMembro = document.getElementById('form-membro');
            if (formMembro) {
                formMembro.addEventListener('submit', salvarMembro);
            }
            
            // C√°lculo autom√°tico de total
            ['homens', 'mulheres', 'criancas'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calcularTotal);
                }
            });
            
            // Data padr√£o para hoje
            const dateInput = document.getElementById('data-culto');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                dateInput.min = '2020-01-01';
                dateInput.max = new Date(new Date().setFullYear(new Date().getFullYear() + 1))
                    .toISOString().split('T')[0];
            }
            
            // M√°scara de telefone
            const telefoneInput = document.getElementById('membro-telefone');
            if (telefoneInput) {
                telefoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.substring(0, 11);
                    
                    if (value.length > 0) {
                        if (value.length <= 2) {
                            value = `(${value}`;
                        } else if (value.length <= 7) {
                            value = `(${value.substring(0,2)}) ${value.substring(2)}`;
                        } else {
                            value = `(${value.substring(0,2)}) ${value.substring(2,7)}-${value.substring(7)}`;
                        }
                    }
                    e.target.value = value;
                });
            }
            
            // Navega√ß√£o por tabs
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Ativa tab clicada
                    document.querySelectorAll('.nav-menu a').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostra conte√∫do correspondente
                    const targetId = this.getAttribute('href').substring(1);
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    document.getElementById(targetId)?.classList.add('active');
                    
                    // Atualiza t√≠tulo
                    const pageTitle = this.querySelector('.nav-text')?.textContent || this.textContent;
                    document.getElementById('current-title').textContent = 
                        pageTitle.split('<')[0].trim();
                    
                    // Fecha sidebar no mobile
                    if (window.innerWidth < 992) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                    
                    // Recria gr√°ficos se necess√°rio
                    if (targetId === 'dashboard') {
                        setTimeout(() => {
                            if (estado.charts.growth) {
                                estado.charts.growth.resize();
                            }
                            if (estado.charts.demo) {
                                estado.charts.demo.resize();
                            }
                        }, 100);
                    }
                });
            });
            
            // Toggle menu mobile
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Fecha menu ao clicar fora (mobile)
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 992) {
                    const sidebar = document.getElementById('sidebar');
                    const toggleBtn = document.getElementById('menu-toggle');
                    
                    if (sidebar.classList.contains('active') && 
                        !sidebar.contains(e.target) && 
                        !toggleBtn.contains(e.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });
        }

        function calcularTotal() {
            const homens = parseInt(document.getElementById('homens').value) || 0;
            const mulheres = parseInt(document.getElementById('mulheres').value) || 0;
            const criancas = parseInt(document.getElementById('criancas').value) || 0;
            document.getElementById('total-presentes').value = homens + mulheres + criancas;
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-toggle').checked = theme === 'dark';
            localStorage.setItem('app-theme', theme);
        }

        function showLoading(message = 'Processando...') {
            const overlay = document.getElementById('loading-overlay');
            const text = document.getElementById('loading-text');
            
            if (overlay && text) {
                text.textContent = message;
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-triangle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Remove ap√≥s 5 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function updateBadges() {
            const dashboardBadge = document.getElementById('dashboard-badge');
            const historicoBadge = document.getElementById('historico-badge');
            
            if (dashboardBadge) dashboardBadge.textContent = estado.cultos.length;
            if (historicoBadge) historicoBadge.textContent = estado.cultos.length;
        }

        function updateLastUpdateTime() {
            // Pode ser usado para mostrar quando os dados foram atualizados
            estado.lastUpdate = new Date().toLocaleTimeString();
        }

        // ==============================================
        // FUN√á√ïES GLOBAIS (para onclick)
        // ==============================================
        window.toggleDarkMode = (isDark) => {
            applyTheme(isDark ? 'dark' : 'light');
        };

        window.exportData = async () => {
            showLoading('Gerando relat√≥rio...');
            
            try {
                // Formata dados para CSV
                const headers = ['Data', 'Tipo', 'Homens', 'Mulheres', 'Crian√ßas', 'Total', 'Ministro', 'Dirigente'];
                const rows = estado.cultos.map(c => [
                    new Date(c.data_culto).toLocaleDateString('pt-BR'),
                    c.tipo_culto,
                    c.homens,
                    c.mulheres,
                    c.criancas,
                    c.homens + c.mulheres + c.criancas,
                    c.ministro,
                    c.dirigente
                ]);
                
                const csvContent = [
                    headers.join(';'),
                    ...rows.map(row => row.join(';'))
                ].join('\n');
                
                // Cria e baixa arquivo
                const blob = new Blob(['\uFEFF' + csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.href = url;
                link.download = `relatorio_cultos_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('Relat√≥rio exportado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('Erro ao gerar relat√≥rio', 'error');
            } finally {
                hideLoading();
            }
        };

        window.logout = () => {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                showToast('Saindo...', 'info');
                setTimeout(() => {
                    // Limpa localStorage se necess√°rio
                    localStorage.removeItem('app-theme');
                    window.location.reload();
                }, 1000);
            }
        };

        window.openModalMembro = () => {
            document.getElementById('modal-membro').style.display = 'flex';
        };

        window.fecharModalMembro = () => {
            document.getElementById('modal-membro').style.display = 'none';
            document.getElementById('form-membro').reset();
            document.getElementById('membro-id').value = '';
        };

        // Mantenha suas fun√ß√µes existentes para editar/deletar
        window.editarMembro = function(id) {
            const membro = estado.membros.find(m => m.id === id);
            if (!membro) return;
            
            document.getElementById('membro-id').value = membro.id;
            document.getElementById('membro-nome').value = membro.nome;
            document.getElementById('membro-telefone').value = membro.telefone || '';
            document.getElementById('membro-nascimento').value = membro.nascimento || '';
            document.getElementById('membro-email').value = membro.email || '';
            document.getElementById('membro-rhema').value = membro.fez_rhema ? 'true' : 'false';
            document.getElementById('membro-escola').value = membro.escola_ministros ? 'true' : 'false';
            
            const select = document.getElementById('membro-departamentos');
            Array.from(select.options).forEach(opt => {
                opt.selected = membro.departamentos && membro.departamentos.includes(opt.value);
            });
            
            document.getElementById('modal-membro').style.display = 'flex';
        };

        window.deletarCulto = async function(id) {
            if (!confirm('Tem certeza que deseja excluir este culto?')) return;
            
            showLoading('Excluindo culto...');
            
            try {
                // Primeiro exclui escalas associadas
                await supabase.from('escalas').delete().eq('culto_id', id);
                
                // Depois exclui o culto
                const { error } = await supabase.from('cultos').delete().eq('id', id);
                
                if (error) throw error;
                
                showToast('Culto exclu√≠do com sucesso!', 'success');
                await loadAllData();
                updateUI();
                
            } catch (error) {
                console.error('Erro ao excluir culto:', error);
                showToast('Erro ao excluir culto', 'error');
            } finally {
                hideLoading();
            }
        };

        window.deletarMembro = async function(id) {
            if (!confirm('Tem certeza que deseja excluir este membro?\nEsta a√ß√£o n√£o pode ser desfeita.')) return;
            
            showLoading('Excluindo membro...');
            
            try {
                const { error } = await supabase
                    .from('membros')
                    .update({ ativo: false })
                    .eq('id', id);
                    // Ou usar delete() para remo√ß√£o permanente:
                    // .delete()
                    // .eq('id', id);
                
                if (error) throw error;
                
                showToast('Membro exclu√≠do!', 'success');
                await loadAllData();
                updateUI();
                
            } catch (error) {
                console.error('Erro ao excluir membro:', error);
                showToast('Erro ao excluir membro', 'error');
            } finally {
                hideLoading();
            }
        };

        // ==============================================
        // INICIALIZA√á√ÉO FINAL
        // ==============================================
        console.log('üìã Aplica√ß√£o carregada. Aguardando DOM...');
    </script>
</body>
</html>
